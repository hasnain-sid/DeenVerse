# DeenVerse — Workspace Instructions

Islamic social media platform (Twitter-like) for hadith sharing, live streaming, and community features. **Currently in v2 redesign** — all new code goes in the v2 layer; legacy code (CRA/Redux) lives in `frontend/src/_legacy/` and is not modified.

---

## Monorepo Layout

```
/
├── frontend/          # Vite + React 18 + TypeScript (v2 redesign)
├── backend/           # Node.js + Express 5 + ESM (JavaScript, not TS yet)
├── packages/
│   ├── shared/        # Shared types, schemas (Zod), utils — imported by both
│   └── mobile/        # Expo (React Native) app
```

npm workspaces are defined at the root `package.json`. Install from root: `npm install`.

---

## Build & Dev Commands

| Task | Command |
|---|---|
| Dev frontend | `npm run dev:web` (port 3000) — or `cd frontend && npm run dev` |
| Dev backend | `npm run dev:backend` (port 8081) — or `cd backend && npm run dev` |
| Dev mobile | `npm run dev:mobile` — Expo Go |
| Build frontend | `npm run build:web` (runs `tsc && vite build`) |
| Lint frontend | `cd frontend && npm run lint` — zero warnings enforced |
| No test runner configured — do not generate test commands |

**Dev proxy**: Vite proxies `/api` and `/socket.io` to `http://localhost:8081`, so frontend code never hard-codes the backend URL in development; use relative paths (`/api/v1/...`).

---

## Architecture

### Auth Pattern (critical)
- **Access token**: short-lived JWT, stored **in Zustand memory only** — never in `localStorage` or cookies.
- **Refresh token**: long-lived, stored in an `httpOnly` cookie (set by backend, invisible to JS).
- Axios instance (`frontend/src/lib/api.ts`) has a 401 interceptor that transparently refreshes via `POST /api/v1/user/refresh`, queuing concurrent requests while in flight.
- `authStore.ts` uses Zustand `persist` with `partialize` to persist only `{ user, isAuthenticated }` — never persists `accessToken`.

### Frontend State
| Concern | Tool |
|---|---|
| Global (auth, theme, UI) | Zustand v5 stores in `src/stores/` |
| Server / async state | TanStack Query v5 — use for all API calls |
| Forms | React Hook Form + Zod (resolver from `@hookform/resolvers`) |

### Frontend Routing
- React Router v6, all page components **lazy-loaded as named exports re-wrapped as default**:
  ```ts
  const MyPage = lazy(() => import('@/features/foo/MyPage').then(m => ({ default: m.MyPage })));
  ```
- Protected routes wrapped in `<AuthGuard>` → `<MainLayout>`.
- Path alias `@` maps to `frontend/src/`.

### Feature Structure (frontend)
New features go in `frontend/src/features/<feature>/`. Each feature owns:
- Page component (`FeaturePage.tsx`)
- Sub-components used only by the feature
- Custom hook (`useFeature.ts`) for TanStack Query calls

Shared/reusable components → `frontend/src/components/`. shadcn/ui primitives → `frontend/src/components/ui/` (generated by CLI, do not manually edit).

### Backend Structure
- ESM throughout (`"type": "module"` in `backend/package.json`) — use `import`/`export`, never `require`/`module.exports`.
- Pattern per resource: `routes/` → `controller/` → `service/` → `models/`
- All routes prefixed `/api/v1/`.
- Middleware order: CORS → securityHeaders (Helmet) → Morgan → cookieParser → express.json → sanitizeInput → rateLimiter → routes → errorHandler.
- Custom `AppError` class (`backend/utils/AppError.js`) for structured errors — use it instead of raw `Error`.
- Centralised error handler at `backend/middlewares/errorHandler.js`.

### Real-time
- Socket.IO server shares the same `http.createServer` instance as Express.
- Socket logic lives in `backend/socket/index.js`.
- Frontend connects via `useSocket()` hook (called once in `App.tsx`).

### Shared Package
Types, Zod schemas, and utils shared between frontend and backend live in `packages/shared/src/`. Import from `@deenverse/shared` (workspace package).

---

## Key Conventions

- **TypeScript strict mode** in frontend: `strict: true`, `noUnusedLocals`, `noUnusedParameters`. Fix all TS errors; do not use `any` unless unavoidable with a comment explaining why.
- **Icons**: Lucide React only (`lucide-react`). Do not import from `react-icons`.
- **Styling**: Tailwind CSS v4 utility classes + shadcn/ui components. Use the `cn()` helper from `src/lib/utils.ts` for conditional classes. Design tokens (colors, spacing) are defined in `src/globals.css`.
- **Animations**: Framer Motion for transitions/animations.
- **Toasts**: `react-hot-toast` (`toast.success`, `toast.error`). Do not use browser `alert`.
- **XSS**: Backend sanitises input via `xss` package middleware. Frontend uses `dompurify` before rendering user HTML.
- **Validation**: Zod schemas in `packages/shared/src/schemas/` whenever the schema is needed on both sides. Frontend-only schemas can stay local.

---

## Environment Variables

| Variable | Where | Purpose |
|---|---|---|
| `VITE_API_URL` | frontend `.env` | Backend base URL (empty = Vite proxy in dev, full URL in prod) |
| `MONGO_URI` | backend `.env` | MongoDB Atlas connection string |
| `REDIS_URL` | backend `.env` | Redis connection string |
| `TOKEN_SECRET` | backend `.env` | JWT access token signing key |
| `REFRESH_TOKEN_SECRET` | backend `.env` | JWT refresh token signing key |
| `FRONTEND_URL_PROD` | backend `.env` | Allowed CORS origin in production |
| `CORS_ORIGINS` | backend `.env` | Extra comma-separated allowed origins |
| `CDN_BASE_URL` | backend `.env` | CloudFront CDN URL (injected into CSP) |
| `AWS_*` | backend `.env` | S3, SES, IVS credentials |
| `PORT` | backend `.env` | Server port (default 8081) |

---

## Pitfalls & Known Issues

- **Do not modify `src/_legacy/`** — archived CRA/Redux code, kept for reference only.
- **Backend is JavaScript, not TypeScript** — the TS migration is planned but not done. Add JSDoc types for complex functions rather than migrating whole files unless asked.
- **Vercel monorepo deployments**: Project Root Directory must be set to the repo root (not `frontend/`). The build command should reference the workspace script (e.g. `npm run build:web`). Setting root to `frontend/` causes "No workspaces found" errors.
- **shadcn/ui components** in `src/components/ui/` are CLI-generated. Re-run `npx shadcn@latest add <component>` to add new ones rather than writing them manually.
- **Mobile `extra.apiUrl`** in `packages/mobile/app.json` is hardcoded to `http://localhost:8081` — update for production builds.
- **CSP `unsafe-inline`** for `scriptSrc` is a known issue noted in `security.js`; do not widen it further.
- **Chunk size limit** is 250 KB — splitting large new dependencies into a named manual chunk in `vite.config.ts` is preferred over ignoring the warning.

---

## Prototyping

When creating UI prototypes, follow the detailed workflow in `.github/instructions/prototyping.instructions.md`. Key points:
- Prototypes live in `frontend/src/features/<feature>/prototypes/` — colocated with their feature.
- Create 3–5 distinct design variants, each in its own `PrototypeN.tsx` file.
- Always include a `PrototypesViewer.tsx` with a toggleable toolbar and register a temporary route at `/prototypes/<feature>`.
- Frontend only — all data is mocked inline. Never modify backend for prototypes.
- Use the existing design system (shadcn/ui, Tailwind, Lucide, Framer Motion).
- After user chooses, promote the selected variant and delete the `prototypes/` folder.
- Use `/prototype` prompt command to invoke this workflow.

---

## Research First

Before implementing new features, run deep research and share a recommendation brief first.

- **Strict gate**: For any create/integrate-new-feature request where research preference is not explicitly stated, ask this confirmation first and wait:
  `Do you want deep research first (internet + GitHub + local codebase), or should I implement directly?`
- Do not start implementation until user confirms one path.

- Use `.github/instructions/research.instructions.md` when user asks for research, deep search, or option comparison.
- Prefer official docs, mature OSS repos, and concrete code examples over generic summaries.
- Compare 2-3 implementation approaches with trade-offs, then recommend one based on current DeenVerse constraints.
- Use `/research` prompt command for repeatable pre-implementation research workflows.
